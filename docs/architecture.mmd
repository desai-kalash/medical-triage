flowchart LR
  %% minimal, CLI-friendly version with quoted labels
  classDef node fill:#111,border:#444,color:#eee,stroke-width:1.2;
  classDef accent fill:#1b3a57,border:#4c8bb3,color:#e7f1f8;
  classDef ext fill:#151515,border:#666,color:#ddd,stroke-dasharray:3 2;

  U["User"]:::node -->|HTTPS| B["Browser UI<br/>index.html / intake.html"]:::node
  B -->|HTTP| H["Akka HTTP Server<br/>(Primary Node 2551)"]:::node

  subgraph C["Akka Cluster (Typed)"]
    direction LR

    subgraph P["Primary Node :2551"]
      H --> UIA["UserInputActor"]:::node
      UIA --> TRA["TriageRouterActor"]:::accent
      TRA --> USA["UserSessionActor<br/>(session memory)"]:::node
      TRA --> RET["RetrievalActor"]:::node
      TRA --> LLM["LLMActor<br/>(Gemini 1.5 Flash)"]:::accent
      TRA --> CARE["EmergencyCareActor<br/>SelfCareActor<br/>AppointmentActor"]:::node
      PLOG["LoggerActor"]:::node
      UIA --> PLOG
      TRA --> PLOG
    end

    subgraph S["Service Node :2552"]
      direction TB
      SRET["RetrievalActor"]:::node
      SLLM["LLMActor"]:::accent
      SCARE["Care Actors"]:::node
      SLOG["LoggerActor"]:::node
    end

    RET <-->|work sharing| SRET
    LLM <-->|backpressure| SLLM
    CARE <-->|failover| SCARE
    PLOG -. audit .- SLOG
  end

  subgraph K["Knowledge Layer"]
    direction TB
    VS["Lucene HNSW<br/>Vector Index"]:::node
    CORPUS["Curated Medical Corpus<br/>(JSONL)"]:::node
  end
  RET -->|ANN search| VS
  VS --> CORPUS

  subgraph EXT["Authoritative Medical Sources"]
    NHS["NHS"]:::ext
    MAYO["Mayo Clinic"]:::ext
    MEDLINE["MedlinePlus"]:::ext
  end
  RET -->|live fetch<br/>on low similarity| NHS
  RET --> MAYO
  RET --> MEDLINE

  LLM -->|prompt + context| TRA
  TRA -->|final assessment<br/>+ urgency| B
